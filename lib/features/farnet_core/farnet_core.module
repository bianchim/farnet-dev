<?php
/**
 * @file
 * Code for the Farnet Core feature.
 */

include_once 'farnet_core.features.inc';

/**
* Implements hook_block_info().
*/
function farnet_core_block_info() {
  $blocks = array();

  $blocks['farnet_core_menu_page'] = array(
    'info' => t('Farnet Field Group Menu Page'),
  );

  return $blocks;
}

/**
* Implements hook_block_view().
*/
function farnet_core_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'farnet_core_menu_page':
      $block['subject'] = '';
      $block['content'] = array(
        '#markup' => _farnet_core_menu_page_content(),
        '#attached' => array(
          'css' => array(
            drupal_get_path('module', 'farnet_core') . '/css/farnet_core_block.css',
          ),
          'js' => array(
            drupal_get_path('module', 'farnet_core') . '/js/farnet_core_block.js',
          ),
        ),
      );
      
      break;
  }

  return $block;
}

function _farnet_core_menu_page_content() {
  $node = node_load(arg(1));
  $field_groups = field_group_info_groups('node', $node->type, 'default');
  $field_groups_sorted = array();

  foreach ($field_groups as $key => $value) {
    if ($value->format_type == 'div') {
      $field_groups_sorted[$value->weight] = $value;
    }
  }

  ksort($field_groups_sorted);
  $output = '<div><nav id="navbar-node-page" class="navbar"><h3>Page contents</h3><ul class="nav">';
  foreach ($field_groups_sorted as $key => $field_group) {
    $output .= '<li><a href="#'.str_replace('_', '-', $field_group->group_name).'">'.$field_group->label.'</a></li>';
  }
  $output .= '</ul></nav></div>';

  return $output;
}